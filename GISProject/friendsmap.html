<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
            <title>Friends Map</title>
            <!-- Materialize CSS -->
            <script type="text/javascript" src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">
            <link rel="stylesheet" href="helper.css">
                <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>
                <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
                    <style>
                        html, body {
                            height: 100%;
                            margin: 0;
                            padding: 0;
                        }
                    #map {
                        height: 100%;
                    }
                    #floating-panel {
                        position: absolute;
                        top: 10px;
                        left: 25%;
                        z-index: 5;

                        padding: 5px;

                        text-align: center;
                        font-family: 'Roboto','sans-serif';
                        line-height: 30px;
                        padding-left: 10px;
                    }

                    #floating-panel2 {
                        position: absolute;
                        top: 10px;
                        left: 45%;
                        z-index: 5;

                        padding: 5px;

                        text-align: center;
                        font-family: 'Roboto','sans-serif';
                        line-height: 30px;
                        padding-left: 10px;
                    }
                    </style>
                     <!-- End of CSS -->

                     <!-- Extra Scripts -->
                     <script async defer
                         src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5SEqwC7aVnIb2mr35lBeykuHL1QL8uBA&libraries=visualization&callback=initMap">
                         </script>

                     <!-- Firebase -->
                     <script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>

                     <!-- GeoFire -->
                     <script src="https://cdn.firebase.com/libs/geofire/4.1.1/geofire.min.js"></script>

                     <!-- End of  Scripts -->



                    </head>

    <body>
      <nav>
        <ul id="list">
          <li><a href="layers.html">Layers</a></li>
          <li><a href="weathermap.html">Weather</a></li>
          <li><a href="heatmap.html">Heatmap</a></li>
          <li><a id="here" href="friendsmap.html">Nearby</a></li>
        </ul>
      </nav>
        <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA5SEqwC7aVnIb2mr35lBeykuHL1QL8uBA&libraries=visualization&callback=initMap">
            </script>
         <div id="map"></div>

        <div id="floating-panel">
            <a class="waves-effect waves-light btn" onclick="saveMyLocation()" id="hideSaveLocationBtn">Save My Location</a>
        </div>

        <div id="floating-panel2">
            <a class="waves-effect waves-light btn" onclick="myDistance()" id="hideMyDistanceBtn">Get Distance</a>
        </div>



        <div class="fixed-action-btn horizontal click-to-toggle" style="bottom: 20px; right: 24px;">
            <a class="btn-floating btn-large red">
                <i class="material-icons">layers</i>
            </a>
            <ul>
                <li><a id="toggleHeatmapID" class="btn-floating yellow" onClick="toggleHeatmap()"><i class="material-icons">insert_chart</i></a></li>
                <li><a class="btn-floating black" href="layers.html"><i class="material-icons">layers_clear</i></a></li>
                <li><a class="btn-floating black" href="weathermap.html"><i class="material-icons">cloud</i></a></li>
                <li><a class="btn-floating black" href="friendsmap.html"><i class="material-icons">cloud</i></a></li>

                <li><a id="toggleMonsterMapID" class="btn-floating orange" onclick="toggleMonsterMap()"><i class="material-icons">insert_chart</i></a></li>
                <li><a id="retrieveLocation" class="btn-floating green" onclick="retrieveLocation()"><i class="material-icons">insert_chart</i></a></li>
            </ul>
        </div>

        <div class="fixed-action-btn" onclick="myCurrentLocation()" style="bottom: 90px; right: 24px;">
            <a class="btn-floating btn-large red">
                <i class="large material-icons">my_location</i>
            </a>

        </div>





        <!-- main script -->
        <script>
            var map, heatmap;
            var image1;
            var directionsDisplay;
            var directionsService;
            var monsterMarker,monsterMap,myCurrentLocationMarker,myCurrentLocationInfoWindow;
            var monsterInfoWindow = null;
            var destinationA,destinationB;
            var desetinationArray = [];
            document.getElementById("toggleMonsterMapID").classList.add('black');
            document.getElementById("retrieveLocation").classList.add('black');

            //marker image
            var image = 'https://maxcdn.icons8.com/Color/PNG/48/Gaming/pokemon-48.png';



            //stored monsters
            var storedMonsters = [];

            //friends from firebase
            var firebaseFriends = [];

            //store locatio  to firebase
            var storeLocationToFirebase = [];

            //monster location
            var monsterLocation = [{
                                   city : 'Block R',
                                   desc : 'Engineering',
                                   lat : 1.378438,
                                   long : 103.848555
                                   },
                                   {
                                   city : 'Block L',
                                   desc : 'Information Technology',
                                   lat : 1.379283,
                                   long : 103.849829
                                   },
                                   {
                                   city : 'Block M',
                                   desc : 'Design',
                                   lat : 1.378526,
                                   long : 103.849934
                                   },
                                   {
                                   city : 'Block N',
                                   desc : 'Incubator',
                                   lat : 1.378121,
                                   long : 103.850057
                                   },
                                   {
                                   city : 'Block P ',
                                   desc : 'Block P',
                                   lat : 1.377976,
                                   long : 103.849408
                                   },
                                   {
                                   city : 'Block Q ',
                                   desc : 'Chemical Life Science',
                                   lat : 1.377856,
                                   long : 103.848600
                                   }
                                   ];

                                   // Get a database reference to our firebase
                                   var ref = new Firebase("https://loba-83587.firebaseio.com/FriendsModule/friendList");

                                   //save location to firebase
                                   var refToFirebase = new Firebase("https://loba-83587.firebaseio.com/FriendsModule/GEOVIS");

                                   // Retrieve new posts as they are added to our database
                                   ref.on("child_added", function(snapshot, prevChildKey) {
                                          var newFriend = snapshot.val();
                                          console.log("Author: " + newFriend.Name);

                                          //add to firebase array
                                          firebaseFriends.push(newFriend)
                                          });


                                          //save my location to firebase
                                          function saveMyLocation(){
                                              Materialize.toast('Save my location', 1500);
                                              document.getElementById('hideSaveLocationBtn').style.visibility = 'hidden';


                                              for ( var i= 0; i < storeLocationToFirebase.length; i++) {
                                                  refToFirebase.push({lat: storeLocationToFirebase[i].lat(), lng: storeLocationToFirebase[i].lng()});
                                              }

                                              console.log("SaVED!")

                                          };

        //get distance
        function myDistance(start, end) {
            var request = {
                origin:  ""+desetinationArray[0].lat+","+desetinationArray[0].lng+"",
                destination:  ""+desetinationArray[1].lat()+","+desetinationArray[1].lng()+"",
                travelMode: google.maps.DirectionsTravelMode.DRIVING
            };
            directionsService.route(request, function(response, status) {
                                    if (status == google.maps.DirectionsStatus.OK) {
                                    directionsDisplay.setDirections(response);
                                    var step = 1;
                                    var infowindow2 = new google.maps.InfoWindow();


                                    var total = 0;
                                    var time  = 0;
                                    var myroute = response.routes[0];
                                    for (var i = 0; i < myroute.legs.length; i++) {
                                    total += myroute.legs[i].distance.value;
                                    time += myroute.legs[i].duration.value
                                    }
                                    total = total / 1000;
                                    // document.getElementById('total').innerHTML = total + ' km';

                                    infowindow2.setContent(total +" km ");

                                    // infowindow2.setContent(response.routes[0].legs[0].steps[step].distance.text + "<br>" + response.routes[0].legs[0].steps[step].duration.text + " ");
                                    infowindow2.setPosition(myroute.legs[0].steps[step].end_location);
                                    infowindow2.open(map);
                                    }
                                    });
        }

        //retrieve location from firebase
        function retrieveLocation(){


            if ( document.getElementById("retrieveLocation").classList.contains('black') ) {

                Materialize.toast('Retrieving Loation Stored!', 2000);
                document.getElementById("retrieveLocation").classList.remove('black');
                document.getElementById("retrieveLocation").classList.add('green');


                //empty previous array
                storedMonsters.empty

                refToFirebase.on("child_added", function(snapshot, prevChildKey) {
                                 // Get latitude and longitude from the cloud.
                                 var newPosition = snapshot.val();

                                 // Create a google.maps.LatLng object for the position of the marker.
                                 // A LatLng object literal (as above) could be used, but the heatmap
                                 // in the next step requires a google.maps.LatLng object.
                                 var latLng = new google.maps.LatLng(newPosition.lat, newPosition.lng);

                                 // Place a marker at that location.
                                 var marker = new google.maps.Marker({
                                                                     position: latLng,
                                                                     map: map
                                                                     });

                                 storedMonsters.push(marker)
                                 });




            }else{
                //set makers to null
                for (var i = 0; i < storedMonsters.length; i++) {
                    storedMonsters[i].setMap(null);
                }

                document.getElementById("retrieveLocation").classList.remove('green');
                document.getElementById("retrieveLocation").classList.add('black');

            }





        };




        //initialise maps
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                                      zoom: 16,
                                      center: {lat: 1.3801, lng: 103.8490},
                                      mapTypeId: google.maps.MapTypeId.MAP,
                                      disableDefaultUI: true,
                                      styles: [
                                               {
                                               "elementType": "geometry.stroke",
                                               "stylers": [
                                                           { "color": "#28e8a8" }
                                                           ]
                                               }
                                               ]
                                      });

                                      heatmap = new google.maps.visualization.HeatmapLayer({
                                                                                           data: getPoints(),
                                                                                           map: map
                                                                                           });

                                                                                           heatmap.set('radius', 40)


                                                                                           monsterInfoWindow = new google.maps.InfoWindow({
                                                                                                                                          content: "loading..."
                                                                                                                                          });

                                                                                                                                          //listen to map click event
                                                                                                                                          map.addListener('click', function(e) {
                                                                                                                                                          addMarker(e.latLng);
                                                                                                                                                          //  refToFirebase.push({lat: e.latLng.lat(), lng: e.latLng.lng()});

                                                                                                                                                          //if have location show button
                                                                                                                                                          if(storeLocationToFirebase.length != 0){
                                                                                                                                                          document.getElementById('hideSaveLocationBtn').style.visibility = 'visible';
                                                                                                                                                          }else{
                                                                                                                                                          document.getElementById('hideSaveLocationBtn').style.visibility = 'hidden';
                                                                                                                                                          }
                                                                                                                                                          })


                                                                                                                                                          //hide save button
                                                                                                                                                          document.getElementById('hideSaveLocationBtn').style.visibility = 'hidden';
                                                                                                                                                          directionsService = new google.maps.DirectionsService();
                                                                                                                                                          directionsDisplay = new google.maps.DirectionsRenderer();
                                                                                                                                                          directionsDisplay.setMap(map);
        };




        // Adds a marker to the map and push to the array.
        function addMarker(location) {
            var storeLocationMarker = new google.maps.Marker({
                                                             position: location,
                                                             map: map,
                                                             draggable :true
                                                             });

                                                             //store in array
                                                             storeLocationToFirebase.push(location);
                                                             desetinationArray.push(location);

                                                             // refToFirebase.push({lat: e.latLng.lat(), lng: e.latLng.lng()});
                                                             //console.log("---> "+storeLocationToFirebase[0].lat()+"long" +storeLocationToFirebase[0].lng())
                                                             //  refToFirebase.push({lat: location.lat(), lng: location.lng()});



        };



        <!-- Get My Location-->
        function myCurrentLocation(){
            Materialize.toast('Getting Your Location...', 1500)
            myCurrentLocationInfoWindow = new google.maps.InfoWindow({map: map});

            // Try HTML5 geolocation.
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                                                         var pos = {
                                                         lat: position.coords.latitude,
                                                         lng: position.coords.longitude
                                                         };

                                                         desetinationArray.push(pos);


                                                         myCurrentLocationInfoWindow.setPosition(pos);
                                                         myCurrentLocationInfoWindow.setContent('You Are Here');
                                                         map.setCenter(pos);


                                                         for (var city in monsterLocation) {
                                                         // Add the circle for this city to the map.
                                                         var cityCircle = new google.maps.Circle({
                                                                                                 strokeColor: '#FF0000',
                                                                                                 strokeOpacity: 0.8,
                                                                                                 strokeWeight: 2,
                                                                                                 fillColor: '#FF0000',
                                                                                                 fillOpacity: 0.1,
                                                                                                 map: map,
                                                                                                 center: pos,
                                                                                                 radius: Math.sqrt(monsterLocation.length) * 20
                                                                                                 });
                                                         }



                                                         }, function() {
                                                         handleLocationError(true, myCurrentLocationInfoWindow, map.getCenter());
                                                         });
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, myCurrentLocationInfoWindow, map.getCenter());
            }

        };
        <!-- end Get My Location-->


        <!-- start of monster map -->

        function toggleMonsterMap(){



            if ( document.getElementById("toggleMonsterMapID").classList.contains('black') ) {

                /*add monster marker to map*/
                /*
                 monsterMaker = new google.maps.Marker({
                 position:{lat: 1.3801, lng: 103.8490},
                 map: map,
                 label: "A",
                 animation: google.maps.Animation.DROP,
                 title: 'Hello World!'
                 });


                 for (var i = 0; i < monsterLocation.length; i++) {
                 var data = monsterLocation[i];

                 var myLatlng = new google.maps.LatLng(data.lat, data.long);
                 monsterMarker = new google.maps.Marker({
                 position: {lat: data.lat, lng: data.long},
                 map: map,
                 animation: google.maps.Animation.DROP,
                 title: data.desc,
                 icon: image
                 })
                 //add monster markers to storedMonster array
                 storedMonsters.push(monsterMarker)
                 };
                 */

                // displayMonsterMarkers() function is called to begin the markers creation
                displayMonsterMarkers();


                Materialize.toast('MonsterMap Enabled!', 2000);
                document.getElementById("toggleMonsterMapID").classList.remove('black');
                document.getElementById("toggleMonsterMapID").classList.add('orange');
            } else {

                /*remove monster marker  */
                //monsterMarker.setMap(null);
                for (var i = 0; i < storedMonsters.length; i++) {
                    storedMonsters[i].setMap(null);
                }





                Materialize.toast('MonsterMap Disabled!', 2000)
                document.getElementById("toggleMonsterMapID").classList.remove('orange');
                document.getElementById("toggleMonsterMapID").classList.add('black');
            };

            monsterMarker.addListener('click', toggleBounce)
        };
        <!-- end of monster map -->

        /*markers animation*/
        function toggleBounce() {
            if (monsterMarker.getAnimation() !== null) {
                monsterMarker.setAnimation(null);
            } else {
                monsterMarker.setAnimation(google.maps.Animation.BOUNCE);
            }};

        function displayMonsterMarkers(){
            var i = 0;
            var bounds = new google.maps.LatLngBounds();

            for ( i= 0; i < firebaseFriends.length; i++) {
                var data = monsterLocation[i];
                var latlng = new google.maps.LatLng(data.lat, data.long);
                bounds.extend(latlng);
                var myLatlng = new google.maps.LatLng(data.lat, data.long);

                /*
                 image1 = 'data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2238%22%20height%3D%2238%22%20viewBox%3D%220%200%2038%2038%22%3E%3Cpath%20fill%3D%22%23808080%22%20stroke%3D%22%23ccc%22%20stroke-width%3D%22.5%22%20d%3D%22M34.305%2016.234c0%208.83-15.148%2019.158-15.148%2019.158S3.507%2025.065%203.507%2016.1c0-8.505%206.894-14.304%2015.4-14.304%208.504%200%2015.398%205.933%2015.398%2014.438z%22%2F%3E%3Ctext%20transform%3D%22translate%2819%2018.5%29%22%20fill%3D%22%23fff%22%20style%3D%22font-family%3A%20Arial%2C%20sans-serif%3Bfont-weight%3Abold%3Btext-align%3Acenter%3B%22%20font-size%3D%2212%22%20text-anchor%3D%22middle%22%3E' + firebaseFriends[i].Name.lable + '%3C%2Ftext%3E%3C%2Fsvg%3E';
                 */


                monsterMarker = new google.maps.Marker({
                                                       position: {lat: data.lat, lng: data.long},
                                                       map: map,
                                                       animation: google.maps.Animation.DROP,
                                                       title: data.desc,
                                                       //icon: image
                                                       icon: image
                                                       });

                                                       monsterMarker.html = '<div>'+ data.city +'<br> '+ firebaseFriends[i].Name+ '<br>'+ firebaseFriends[i].Level+ '<br><img src="'+firebaseFriends[i].ThumbnailImgUrl+'" alt="Mountain View" style="width:80px;height:80spx;">'+'</div>';

                                                       google.maps.event.addListener(monsterMarker, 'click', function(){
                                                                                     // Set the content of the InfoBubble or InfoWindow
                                                                                     // They both have a function called setContent
                                                                                     monsterInfoWindow.setContent(this.html);
                                                                                     monsterInfoWindow.open(map, this);
                                                                                     map.setZoom(map.getZoom() + 1);
                                                                                     map.setCenter(monsterMarker.getPosition());
                                                                                     });

                                                                                     storedMonsters.push(monsterMarker)

            }
            map.fitBounds(bounds);
            //end of for loop
        };




        function toggleHeatmap() {
            heatmap.setMap(heatmap.getMap() ? null : map);
            //toggle FAB (the floating button thing) highlight
            if ( document.getElementById("toggleHeatmapID").classList.contains('black') ) {
                Materialize.toast('Heatmap Enabled!', 2000)
                document.getElementById("toggleHeatmapID").classList.remove('black');
                document.getElementById("toggleHeatmapID").classList.add('yellow');
            } else {
                Materialize.toast('Heatmap Disabled!', 2000)
                document.getElementById("toggleHeatmapID").classList.remove('yellow');
                document.getElementById("toggleHeatmapID").classList.add('black');
            }
        };

        // Heatmap data: 500 Points
        function getPoints() {
            return [
                    new google.maps.LatLng(1.38098127843023, 103.8486879226299),
                    new google.maps.LatLng(1.382170199449567, 103.8482437025494),
                    new google.maps.LatLng(1.381602205990674, 103.8485798830626),
                    new google.maps.LatLng(1.38184627856266, 103.849257778687),
                    new google.maps.LatLng(1.381936042993424, 103.8495859442111),
                    new google.maps.LatLng(1.38043331828994, 103.848909794732),
                    new google.maps.LatLng(1.381887230073275, 103.8501239042656),
                    new google.maps.LatLng(1.381524104067059, 103.8491558700535),
                    new google.maps.LatLng(1.382110326117077, 103.8485657398038),
                    new google.maps.LatLng(1.382336234915819, 103.8492496518433),
                    ];

        }



            </script>
        <!-- End of main script -->



    </body>
</html>
